<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SFU design log - Bulma</title>
  <link rel="stylesheet" href="../assets/css/bulma.min.css">
</head>

<body>
  <div class="container">
  <nav class="navbar has-shadow is-transparent">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
        <h1 class="title">Bulma</h1>
      </a>
      <div class="navbar-burger burger" data-target="navbarExampleTransparentExample">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>

    <div id="navbarExampleTransparentExample" class="navbar-menu">
      <div class="navbar-start">
        
        
        <a class="navbar-item" href="..">
          Home
        </a>
        
        
        
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="..">
            Changelog
          </a>
          <div class="navbar-dropdown is-boxed">
            
            <a class="navbar-item" href="../changelog/v0.0.1/">
              v0.0.1
            </a>
            
          </div>
        </div>
        
        
      </div>

      <div class="navbar-end">
        <div class="navbar-item">
          <div class="field is-grouped">
            <p class="control">
              <a class="bd-tw-button button" data-social-network="Twitter" data-social-action="tweet"
                data-social-target="http://localhost:4000" target="_blank"
                href="https://twitter.com/intent/tweet?text=Bulma: a modern CSS framework based on Flexbox&amp;hashtags=bulmaio&amp;url=http://localhost:4000&amp;via=jgthms">
                <span class="icon">
                  <i class="fab fa-twitter"></i>
                </span>
                <span>
                  Tweet
                </span>
              </a>
            </p>
            <p class="control">
              <a class="button is-primary"
                href="https://github.com/jgthms/bulma/releases/download/0.7.1/bulma-0.7.1.zip">
                <span class="icon">
                  <i class="fas fa-download"></i>
                </span>
                <span>Download</span>
              </a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </nav>
</div>
  <section class="section">
    <div class="container">
      <div class="columns">
        <div class="column is-one-quarter">
          <aside class="menu">
  
    <p class="menu-label">
      SFU design log
    </p>

    
      <ul class="menu-list">
        <li><a href="#sfu-design-log">SFU design log</a>
  
    <ul>
      
        <li><a href="#1-12-20-allow-subs-to-connect-without-ingress-present">1-12-20 Allow subs to connect without ingress present</a>
  
    <ul>
      
        <li><a href="#how-to-do-re-negotiation">how to do re-negotiation</a>
  
</li>
      
    </ul>
  
</li>
      
        <li><a href="#1-13-21-notes-on-tracks">1 13 21 notes on tracks</a>
  
</li>
      
        <li><a href="#1-14-21-notes-on-track-switching">1 14 21 notes on track switching</a>
  
</li>
      
        <li><a href="#1-14-21-notes-on-number-of-channels-for-subscribers-to-sfu">1 14 21 notes on number of channels for subscribers to sfu</a>
  
</li>
      
        <li><a href="#1-14-21-notes-on-why-the-issfu-param-is-not-necessary">1 14 21 notes on why the 'issfu' param is not necessary</a>
  
</li>
      
        <li><a href="#1-29-21-why-we-need-a-splicer-in-front-of-each-pion-video-track">1 29 21 Why we need a splicer in front of each Pion video track</a>
  
</li>
      
    </ul>
  
</li>
      </ul>
    
  
</aside>
        </div>
        
        <div class="column">
          <div class="content">
             <h1 id="sfu-design-log">SFU design log</h1>
<h2 id="1-12-20-allow-subs-to-connect-without-ingress-present">1-12-20 Allow subs to connect without ingress present</h2>
<p>Few ways to do this:
- Don't do it, only allow subs to connect after pub: current mode
- Specify one node as 'root', only root allows subs without pub.
- root gives subs 3txs for video, but ONLY transmits idle-video on first of 3x
- when root ingress comes, if 3x simulcast, we fill the 3x tracks with video
- when root ingress comes. if just 1x video, we only send on first of 3x tracks
- this means no re-negotiation is necessary.
- This also means an SFU always creates 3x video tracks to a subscriber.
- It may not fill those tracks with media, depending upon what hits it's ingress,
but the tracks are ready if simulcast comes in, or if 3x non-simu comes in.</p>
<h3 id="how-to-do-re-negotiation">how to do re-negotiation</h3>
<ul>
<li>no apparent need to support this yet, but....</li>
<li>use long polling</li>
<li>use whip-like, offer from browser, answer from sfu</li>
</ul>
<h2 id="1-13-21-notes-on-tracks">1 13 21 notes on tracks</h2>
<p>Each subscriber has ZERO local tracks!
We stop using NewTrackLocalStaticRTP to create a track for each subscriber.
we use addtrack(audio), addtrack(video1), addtrack(video1),
and then replacetrack on keyframe before using WriteRTP to write the RTP to a particulae track</p>
<h2 id="1-14-21-notes-on-track-switching">1 14 21 notes on track switching</h2>
<p>Subscribers do NOT get their own local tracks.
Subscribers do have an RtpSender for each track towards the sub.
Browser's just get a single track towards them.
We switch media towards the browser by checking each RX packet on each RX track.
When it is a true keyframe, AND there are sub's requesting this RX track, then we use 
 pc.ReplaceTrack() before we write the media to the local track.
This should ensure that the sub will start receiving media from the localtrack it is waiting
to join.</p>
<h2 id="1-14-21-notes-on-number-of-channels-for-subscribers-to-sfu">1 14 21 notes on number of channels for subscribers to sfu</h2>
<p>When browsers subscribe to sfu, they offer 1 m=video recvonly section
When sfus subscribe to another sfu, they offer 3 m=video recvonly section
The upstream sfu, uses the number of offered receivers </p>
<h2 id="1-14-21-notes-on-why-the-issfu-param-is-not-necessary">1 14 21 notes on why the 'issfu' param is not necessary</h2>
<p><code>&amp;sfu=1</code> was a query param from sub to upstream sfu. it indicated to 
the upstream how many tracks it should push to the downstream.
it turns out the number of m=video sections is a cleaner way to do this.</p>
<h2 id="1-29-21-why-we-need-a-splicer-in-front-of-each-pion-video-track">1 29 21 Why we need a splicer in front of each Pion video track</h2>
<p>If we only ever had a single RTP source for each RTP destination, 
RTP splicers would not be necessary
This would look like: 
- Ingest could only connect a single time for RTP continuity
- Restart would be necessary for new ingress connection
- (Or all subscribers would be required to re-connect for new ingress)
- No Idle video loop would be possible, as this requires switching between ingress and idle loop RTP stream.
- Also, without RTP splicing, A/B/C simulcast switching is basically impossible.</p>
<p>Thus, to support these three features (ingress reconnect, idle-loop, simulcast switching)</p> 
          </div>
        </div>
      </div>
    </div>
  </section>
</body>

</html>